#!/bin/bash

# Script to run mock server integration tests safely
# 
# CRITICAL: Mock server tests MUST run sequentially to prevent race conditions
# They share a single daemon instance and modify shared configuration

set -e

echo "ğŸ§ª Running Mock Server Integration Tests"
echo ""
echo "âš ï¸  IMPORTANT: Tests run sequentially to prevent race conditions"
echo "   - Tests share a single suibase-daemon instance"
echo "   - Tests modify shared suibase.yaml configuration"
echo "   - Parallel execution would cause state contention"
echo ""

# Change to the correct directory
cd "$(dirname "$0")/../../rust/suibase"

# Run tests with explicit single-threaded execution and exit on first failure
echo "ğŸ”’ Running tests with --test-threads=1 for safety..."
echo "âš¡ Will exit on first failure for easier debugging"

# Get list of all test names and run them one by one, stopping on first failure
echo "ğŸ“‹ Discovering available tests..."
test_names=$(cargo test --test mock_server_integration_tests -- --list | grep ": test$" | sed 's/: test$//')

echo "ğŸ§ª Running tests sequentially, stopping on first failure:"
for test_name in $test_names; do
    echo "  ğŸ” Running: $test_name"
    if ! cargo test --test mock_server_integration_tests "$test_name" -- --test-threads=1 --nocapture; then
        echo "âŒ Test failed: $test_name"
        echo "ğŸ›‘ Stopping execution due to test failure"
        exit 1
    fi
    echo "  âœ… Passed: $test_name"
done

echo ""
echo "âœ… Mock server tests completed"
echo ""
echo "ğŸ’¡ To run a specific test:"
echo "   cargo test test_selectable_flag_respected -- --nocapture"
echo ""
echo "ğŸ§¹ To restore default configuration after tests:"
echo "   $(dirname "$0")/restore-default-config"